<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .sidebar {
      height: 100vh;
      background-color: #ffffff;
      border-right: 1px solid #dee2e6;
    }
    .nav-link.active {
      background-color: #0d6efd !important;
      color: #fff !important;
    }
    .logout-btn {
      color: #9e9e9e;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: color 0.2s;
    }
    .logout-btn:hover {
      color: #dcdcdc;
      text-decoration: none;
    }
    .tab-links {
      margin-bottom: 1rem;
    }
    .tab-links a {
      margin-right: 1rem;
    }
    .role-badge {
      background-color: #e9ecef;
      padding: 3px 8px;
      border-radius: 4px;
      margin: 2px;
      display: inline-block;
    }
    nav.nav.mb-3 .nav-link {
      color: black !important;
      background-color: transparent !important;
    }

    nav.nav.mb-3 .nav-link.active {
      color: #0d6efd !important;
      background-color: transparent !important;
    }
  </style>
</head>
<body>

<!-- Верхняя панель -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid justify-content-between">
    <span class="navbar-brand mb-0 h1">
      <span th:text="${currentUser.email}"></span> with roles:
      <span th:each="role, stat : ${currentUser.roles}">
        <span th:text="${role.name.replace('ROLE_', '')}"></span>
        <span th:if="${!stat.last}">, </span>
      </span>
    </span>
    <form th:action="@{/logout}" method="post" class="my-auto">
      <button type="submit" class="logout-btn">Logout</button>
    </form>
  </div>
</nav>
<div class="container-fluid">
  <div class="row">

    <!-- Левое меню -->
    <div class="col-md-2 sidebar p-3">
      <ul class="nav flex-column" id="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/admin" id="adminLink">Admin</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/user" id="userLink" onclick="sessionStorage.setItem('cameFromAdmin', 'true')">User</a>
        </li>
      </ul>
    </div>

    <!-- Основной контент -->
    <div class="col-md-10 p-4">
      <h2 class="mb-4">Admin panel</h2>

      <!-- Навигация по вкладкам -->
      <nav class="nav mb-3">
        <a class="nav-link" href="#" id="showUsers">Users table</a>
        <a class="nav-link" href="#" id="showNewUserForm">New User</a>
      </nav>

      <!-- Таблица пользователей -->
      <div id="users-table" class="tab-content">
        <h4>All users</h4>
        <table class="table table-bordered table-hover mt-3">
          <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Age</th>
            <th>Email</th>
            <th>Role</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
          </thead>
          <tbody id="users-body"> <!-- Данные будут здесь -->
          </tbody>
        </table>
      </div>

      <!-- Форма добавления нового пользователя -->
      <div id="new-user-form" class="tab-content d-none">
        <div class="card-header bg-light">
          <h5 class="mb-0 text-center">Add new user</h5>
        </div>
        <div class="card-body">
          <form th:action="@{/admin/create}" method="post">
            <div class="mb-3 d-flex flex-column align-items-center">
              <label for="age" class="form-label fw-bold text-center" style="width: 400px;">Age</label>
              <input type="number" name="age" id="age" class="form-control" style="width: 400px;" placeholder="Age" required>
            </div>
            <div class="mb-3 d-flex flex-column align-items-center">
              <label for="email" class="form-label fw-bold text-center" style="width: 400px;">Email</label>
              <input type="email" name="email" id="email" class="form-control" style="width: 400px;" placeholder="Email" required>
            </div>
            <div class="mb-3 d-flex flex-column align-items-center">
              <label for="password" class="form-label fw-bold text-center" style="width: 400px;">Password</label>
              <input type="password" name="password" id="password" class="form-control" style="width: 400px;" placeholder="Password" required>
            </div>
            <div class="mb-3 d-flex flex-column align-items-center">
              <label for="roles" class="form-label fw-bold text-center" style="width: 400px;">Roles</label>
              <select name="roleIds" id="roles" class="form-select" style="width: 400px;">
                <option th:each="role : ${allRoles}" th:value="${role.id}" th:text="${role.name.replace('ROLE_', '')}"></option>
              </select>
            </div>
            <div class="mb-3 d-flex justify-content-center">
              <button type="submit" class="btn btn-success" style="width: 400px;">Add new user</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Update -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form th:action="@{/admin/update}" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Edit user</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editUserId">

          <div class="mb-3 d-flex flex-column align-items-center">
            <label for="editEmail" class="form-label fw-bold text-center" style="width: 300px;">Email</label>
            <input type="email" name="email" id="editEmail" class="form-control" style="max-width: 300px;" required>
          </div>

          <div class="mb-3 d-flex flex-column align-items-center">
            <label for="editAge" class="form-label fw-bold text-center" style="width: 300px;">Age</label>
            <input type="number" name="age" id="editAge" class="form-control" style="max-width: 300px;" required>
          </div>

          <div class="mb-3 d-flex flex-column align-items-center">
            <label for="editPassword" class="form-label fw-bold text-center" style="width: 300px;">Password</label>
            <input type="password" name="password" id="editPassword" class="form-control" style="max-width: 300px;">
          </div>

          <div class="mb-3 d-flex flex-column align-items-center">
            <label for="editRoles" class="form-label fw-bold text-center" style="width: 300px;">Roles</label>
            <select name="roleIds" id="editRoles" multiple class="form-select" style="max-width: 300px;">
              <option th:each="role : ${allRoles}" th:value="${role.id}" th:text="${role.name.replace('ROLE_', '')}"></option>
            </select>
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-center">
          <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form th:action="@{/admin/delete}" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Delete user</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="deleteUserId">
          <p>Are you sure you want to delete this user?</p>
          <div class="user-info"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-danger" type="submit">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const showUsers = document.getElementById('showUsers');
    const showNew = document.getElementById('showNewUserForm');
    const usersTable = document.getElementById('users-table');
    const newForm    = document.getElementById('new-user-form');

    const tabs = [showUsers, showNew];

    function activate(tab) {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    }

    showUsers.addEventListener('click', e => {
      e.preventDefault();
      activate(showUsers);
      usersTable.classList.remove('d-none');
      newForm.classList.add('d-none');
    });

    showNew.addEventListener('click', e => {
      e.preventDefault();
      activate(showNew);
      newForm.classList.remove('d-none');
      usersTable.classList.add('d-none');
    });

    activate(showUsers);
    usersTable.classList.remove('d-none');
    newForm.classList.add('d-none');
  });
  document.addEventListener('DOMContentLoaded', function () {
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const userId = button.getAttribute('data-bs-userid');
      const row = button.closest('tr');

      document.getElementById('editUserId').value = userId;
      document.querySelector('#editModal input[name="email"]').value = row.cells[2].textContent.trim();
      document.querySelector('#editModal input[name="age"]').value = row.cells[1].textContent.trim();

      const roles = Array.from(row.cells[3].querySelectorAll('.role-badge'))
              .map(badge => badge.textContent.trim());

      Array.from(document.querySelectorAll('#editModal select[name="roleIds"] option')).forEach(option => {
        option.selected = roles.includes(option.textContent.trim());
      });
    });

    const deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const userId = button.getAttribute('data-bs-userid');
      const row = button.closest('tr');

      document.getElementById('deleteUserId').value = userId;
      const userEmail = row.cells[2].textContent.trim();

      document.querySelector('#deleteModal .user-info').innerHTML = `
        <p>User ID: ${userId}</p>
        <p>Email: ${userEmail}</p>
      `;
    });
  });

  const path = window.location.pathname;

  if (path === '/admin') {
    const adminLink = document.getElementById('adminLink');
    if (adminLink) {
      adminLink.classList.add('active');
    }
  } else if (path === '/user') {
    const userLink = document.getElementById('userLink');
    if (userLink) {
      userLink.classList.add('active');
    }
  }

  // Функция для загрузки пользователей
  async function fetchUsers() {
    try {
      const response = await fetch('/api/admin', {
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include' // Для передачи куки (если используется сессия)
      });
      const users = await response.json();
      renderUsers(users);
    } catch (error) {
      console.error('Ошибка:', error);
    }
  }

  // Функция для отрисовки пользователей
  function renderUsers(users) {
    const tbody = document.getElementById('users-body');
    tbody.innerHTML = ''; // Очищаем таблицу

    users.forEach(user => {
      const row = `
      <tr>
        <td>${user.id}</td>
        <td>${user.age}</td>
        <td>${user.email}</td>
        <td>
          ${user.roles.map(role => `<span class="role-badge">${role.name.replace('ROLE_', '')}</span>`).join('')}
        </td>
        <td>
          <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#editModal" data-bs-userid="${user.id}">Edit</button>
        </td>
        <td>
          <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-bs-userid="${user.id}">Delete</button>
        </td>
      </tr>
    `;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  // Загружаем данные при загрузке страницы
  document.addEventListener('DOMContentLoaded', fetchUsers);
</script>
</body>
</html>



